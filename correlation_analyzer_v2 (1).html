<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°ì´í„° ìƒê´€ê´€ê³„ ë¶„ì„ ì„œë¹„ìŠ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        
        .card-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 16px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9ff;
        }
        
        .upload-area:hover {
            background: #eef0ff;
            border-color: #5a67d8;
        }
        
        .upload-area.dragover {
            background: #e0e4ff;
            border-color: #4c51bf;
        }
        
        .upload-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 0.9rem;
            color: #888;
        }
        
        .file-input {
            display: none;
        }
        
        .file-info {
            display: none;
            background: #e8f5e9;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 20px;
            align-items: center;
            gap: 15px;
        }
        
        .file-info.show {
            display: flex;
        }
        
        .file-icon {
            font-size: 2rem;
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: #2e7d32;
        }
        
        .file-meta {
            font-size: 0.85rem;
            color: #666;
        }
        
        .remove-file {
            background: #ef5350;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .remove-file:hover {
            background: #d32f2f;
        }
        
        .column-section {
            display: none;
        }
        
        .column-section.show {
            display: block;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 18px;
            background: #f8f9fa;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .checkbox-item:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .checkbox-item.selected {
            background: #667eea;
            color: white;
            border-color: #5a67d8;
        }
        
        .checkbox-item input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            cursor: pointer;
            font-weight: 500;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            font-size: 1rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            box-shadow: 0 5px 20px rgba(108, 117, 125, 0.4);
        }
        
        .chart-section {
            display: none;
        }
        
        .chart-section.show {
            display: block;
        }
        
        .heatmap-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .heatmap-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #heatmapCanvas {
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .color-scale {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        
        .color-scale-bar {
            width: 30px;
            height: 300px;
            border-radius: 4px;
            background: linear-gradient(to bottom, #1a9850, #91cf60, #fee08b, #fc8d59, #d73027);
        }
        
        .color-scale-labels {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 300px;
            margin-left: 8px;
            font-size: 0.85rem;
            color: #666;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }
        
        .interpretation {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
        }
        
        .interpretation h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        
        .interpretation-item {
            padding: 15px;
            margin: 12px 0;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            line-height: 1.6;
        }
        
        .interpretation-item.insight {
            border-left-color: #28a745;
        }
        
        .correlation-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .strong-positive { background: #d4edda; color: #155724; }
        .moderate-positive { background: #fff3cd; color: #856404; }
        .weak { background: #e2e3e5; color: #383d41; }
        .moderate-negative { background: #f8d7da; color: #721c24; }
        .strong-negative { background: #f5c6cb; color: #721c24; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px 20px;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        
        .warning.show {
            display: block;
        }
        
        .info-box {
            background: #e7f3ff;
            color: #0c5460;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .preview-table th,
        .preview-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .preview-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        .preview-table tr:hover {
            background: #f5f5f5;
        }
        
        .preview-container {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .tooltip {
            position: fixed;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            pointer-events: none;
            z-index: 1000;
            display: none;
            max-width: 250px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ë°ì´í„° ìƒê´€ê´€ê³„ ë¶„ì„ ì„œë¹„ìŠ¤</h1>
        
        <div class="card">
            <div class="card-title">1. ë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ</div>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">CSV íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
                <div class="upload-hint">ì§€ì› í˜•ì‹: .csv (UTF-8 ê¶Œì¥)</div>
                <input type="file" class="file-input" id="fileInput" accept=".csv">
            </div>
            
            <div class="file-info" id="fileInfo">
                <div class="file-icon">ğŸ“„</div>
                <div class="file-details">
                    <div class="file-name" id="fileName"></div>
                    <div class="file-meta" id="fileMeta"></div>
                </div>
                <button class="remove-file" onclick="removeFile()">ì‚­ì œ</button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <div>íŒŒì¼ì„ ë¶„ì„í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>
        </div>
        
        <div class="card column-section" id="columnSection">
            <div class="card-title">2. ë¶„ì„í•  ì»¬ëŸ¼ ì„ íƒ</div>
            <div class="info-box">
                ğŸ’¡ ìˆ˜ì¹˜í˜• ë°ì´í„° ì»¬ëŸ¼ë§Œ í‘œì‹œë©ë‹ˆë‹¤. ìƒê´€ê´€ê³„ë¥¼ ë¶„ì„í•  ì»¬ëŸ¼ì„ 2ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.
            </div>
            <div class="checkbox-group" id="columnCheckboxes"></div>
            <div class="btn-group">
                <button class="btn" onclick="analyzeCorrelation()">ğŸ” ìƒê´€ê´€ê³„ ë¶„ì„</button>
                <button class="btn btn-secondary" onclick="selectAll()">ì „ì²´ ì„ íƒ</button>
                <button class="btn btn-secondary" onclick="deselectAll()">ì „ì²´ í•´ì œ</button>
            </div>
            <div class="warning" id="warning">âš ï¸ ìµœì†Œ 2ê°œ ì´ìƒì˜ ì»¬ëŸ¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
            
            <div style="margin-top: 25px;">
                <h4 style="margin-bottom: 10px; color: #555;">ğŸ“‹ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ìƒìœ„ 5í–‰)</h4>
                <div class="preview-container">
                    <table class="preview-table" id="previewTable"></table>
                </div>
            </div>
        </div>
        
        <div class="card chart-section" id="chartSection">
            <div class="card-title">3. ìƒê´€ê´€ê³„ íˆíŠ¸ë§µ</div>
            <div class="heatmap-container">
                <div class="heatmap-wrapper">
                    <canvas id="heatmapCanvas"></canvas>
                </div>
                <div class="color-scale">
                    <div style="display: flex;">
                        <div class="color-scale-bar"></div>
                        <div class="color-scale-labels">
                            <span>+1.0</span>
                            <span>+0.5</span>
                            <span>0</span>
                            <span>-0.5</span>
                            <span>-1.0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #d73027;"></div>
                    <span>ê°•í•œ ìŒì˜ ìƒê´€ (-1.0)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #fee08b;"></div>
                    <span>ìƒê´€ ì—†ìŒ (0)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1a9850;"></div>
                    <span>ê°•í•œ ì–‘ì˜ ìƒê´€ (+1.0)</span>
                </div>
            </div>
        </div>
        
        <div class="card chart-section" id="interpretationSection">
            <div class="card-title">4. ë¶„ì„ ê²°ê³¼ í•´ì„</div>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="maxCorr">-</div>
                    <div class="stat-label">ìµœëŒ€ ìƒê´€ê³„ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="minCorr">-</div>
                    <div class="stat-label">ìµœì†Œ ìƒê´€ê³„ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgCorr">-</div>
                    <div class="stat-label">í‰ê·  |ìƒê´€ê³„ìˆ˜|</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="pairCount">-</div>
                    <div class="stat-label">ë¶„ì„ ìŒ ìˆ˜</div>
                </div>
            </div>
            <div class="interpretation" id="interpretation">
                <div id="interpretationContent"></div>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>

    <script>
        let parsedData = [];
        let numericColumns = [];
        let allColumns = [];
        let currentMatrix = [];
        let currentLabels = [];

        // CSV íŒŒì„œ (PapaParse ëŒ€ì²´)
        function parseCSV(text) {
            const lines = text.split(/\r\n|\n/);
            const result = { data: [], meta: { fields: [] } };
            
            if (lines.length === 0) return result;
            
            // í—¤ë” íŒŒì‹±
            const headers = parseCSVLine(lines[0]);
            result.meta.fields = headers;
            
            // ë°ì´í„° íŒŒì‹±
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    let val = values[index] || '';
                    // ìˆ«ì ë³€í™˜ ì‹œë„
                    const numVal = parseFloat(val);
                    row[header] = !isNaN(numVal) && val.trim() !== '' ? numVal : val;
                });
                result.data.push(row);
            }
            
            return result;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            
            return result;
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });

        function processFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('CSV íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            document.getElementById('loading').classList.add('show');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const results = parseCSV(text);
                    
                    document.getElementById('loading').classList.remove('show');
                    
                    parsedData = results.data;
                    allColumns = results.meta.fields || [];
                    
                    numericColumns = findNumericColumns(parsedData, allColumns);
                    
                    showFileInfo(file, parsedData.length, allColumns.length, numericColumns.length);
                    createColumnCheckboxes(numericColumns);
                    showDataPreview(parsedData, allColumns);
                    
                    document.getElementById('columnSection').classList.add('show');
                    document.getElementById('chartSection').classList.remove('show');
                    document.getElementById('interpretationSection').classList.remove('show');
                } catch (error) {
                    document.getElementById('loading').classList.remove('show');
                    alert('íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜: ' + error.message);
                }
            };
            reader.onerror = function() {
                document.getElementById('loading').classList.remove('show');
                alert('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            };
            reader.readAsText(file, 'UTF-8');
        }

        function findNumericColumns(data, columns) {
            const numeric = [];
            columns.forEach(col => {
                let isNumeric = true;
                let hasValue = false;
                
                for (let i = 0; i < Math.min(data.length, 100); i++) {
                    const val = data[i][col];
                    if (val !== null && val !== undefined && val !== '') {
                        hasValue = true;
                        if (typeof val !== 'number' || isNaN(val)) {
                            isNumeric = false;
                            break;
                        }
                    }
                }
                
                if (isNumeric && hasValue) {
                    numeric.push(col);
                }
            });
            return numeric;
        }

        function showFileInfo(file, rows, totalCols, numCols) {
            document.getElementById('fileInfo').classList.add('show');
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileMeta').textContent = 
                `${rows.toLocaleString()}í–‰ Ã— ${totalCols}ì—´ (ìˆ˜ì¹˜í˜• ì»¬ëŸ¼: ${numCols}ê°œ)`;
            uploadArea.style.display = 'none';
        }

        function removeFile() {
            parsedData = [];
            numericColumns = [];
            allColumns = [];
            fileInput.value = '';
            
            document.getElementById('fileInfo').classList.remove('show');
            uploadArea.style.display = 'block';
            document.getElementById('columnSection').classList.remove('show');
            document.getElementById('chartSection').classList.remove('show');
            document.getElementById('interpretationSection').classList.remove('show');
        }

        function createColumnCheckboxes(columns) {
            const container = document.getElementById('columnCheckboxes');
            container.innerHTML = '';
            
            columns.forEach((col, index) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.onclick = function() { toggleCheckbox(this); };
                div.innerHTML = `
                    <input type="checkbox" id="col_${index}" value="${col}">
                    <label for="col_${index}">${col}</label>
                `;
                container.appendChild(div);
            });
        }

        function showDataPreview(data, columns) {
            const table = document.getElementById('previewTable');
            let html = '<thead><tr>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            const previewRows = data.slice(0, 5);
            previewRows.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const val = row[col];
                    html += `<td>${val !== null && val !== undefined ? val : '-'}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody>';
            table.innerHTML = html;
        }

        function toggleCheckbox(element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;
            element.classList.toggle('selected', checkbox.checked);
        }

        function selectAll() {
            document.querySelectorAll('#columnCheckboxes .checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input');
                checkbox.checked = true;
                item.classList.add('selected');
            });
        }

        function deselectAll() {
            document.querySelectorAll('#columnCheckboxes .checkbox-item').forEach(item => {
                const checkbox = item.querySelector('input');
                checkbox.checked = false;
                item.classList.remove('selected');
            });
        }

        function getSelectedColumns() {
            const checkboxes = document.querySelectorAll('#columnCheckboxes input:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function calculateCorrelation(x, y) {
            const pairs = [];
            for (let i = 0; i < x.length; i++) {
                if (x[i] !== null && y[i] !== null && !isNaN(x[i]) && !isNaN(y[i])) {
                    pairs.push([x[i], y[i]]);
                }
            }
            
            if (pairs.length < 2) return 0;
            
            const n = pairs.length;
            const xVals = pairs.map(p => p[0]);
            const yVals = pairs.map(p => p[1]);
            
            const sumX = xVals.reduce((a, b) => a + b, 0);
            const sumY = yVals.reduce((a, b) => a + b, 0);
            const sumXY = xVals.reduce((total, xi, i) => total + xi * yVals[i], 0);
            const sumX2 = xVals.reduce((total, xi) => total + xi * xi, 0);
            const sumY2 = yVals.reduce((total, yi) => total + yi * yi, 0);
            
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            return denominator === 0 ? 0 : numerator / denominator;
        }

        function getCorrelationColor(r) {
            // -1 ~ +1 ì‚¬ì´ì˜ ê°’ì„ ìƒ‰ìƒìœ¼ë¡œ ë³€í™˜
            const colors = [
                { pos: -1, r: 215, g: 48, b: 39 },    // ë¹¨ê°•
                { pos: -0.5, r: 252, g: 141, b: 89 }, // ì£¼í™©
                { pos: 0, r: 254, g: 224, b: 139 },   // ë…¸ë‘
                { pos: 0.5, r: 145, g: 207, b: 96 },  // ì—°ë‘
                { pos: 1, r: 26, g: 152, b: 80 }      // ì´ˆë¡
            ];
            
            let lower = colors[0];
            let upper = colors[colors.length - 1];
            
            for (let i = 0; i < colors.length - 1; i++) {
                if (r >= colors[i].pos && r <= colors[i + 1].pos) {
                    lower = colors[i];
                    upper = colors[i + 1];
                    break;
                }
            }
            
            const range = upper.pos - lower.pos;
            const factor = range === 0 ? 0 : (r - lower.pos) / range;
            
            const red = Math.round(lower.r + factor * (upper.r - lower.r));
            const green = Math.round(lower.g + factor * (upper.g - lower.g));
            const blue = Math.round(lower.b + factor * (upper.b - lower.b));
            
            return `rgb(${red}, ${green}, ${blue})`;
        }

        function getCorrelationStrength(r) {
            const absR = Math.abs(r);
            if (absR >= 0.7) return r > 0 ? { text: 'ê°•í•œ ì–‘ì˜ ìƒê´€', class: 'strong-positive' } : { text: 'ê°•í•œ ìŒì˜ ìƒê´€', class: 'strong-negative' };
            if (absR >= 0.4) return r > 0 ? { text: 'ë³´í†µ ì–‘ì˜ ìƒê´€', class: 'moderate-positive' } : { text: 'ë³´í†µ ìŒì˜ ìƒê´€', class: 'moderate-negative' };
            return { text: 'ì•½í•œ ìƒê´€', class: 'weak' };
        }

        function analyzeCorrelation() {
            const selectedCols = getSelectedColumns();
            const warning = document.getElementById('warning');
            
            if (selectedCols.length < 2) {
                warning.classList.add('show');
                return;
            }
            warning.classList.remove('show');

            const n = selectedCols.length;
            const correlationMatrix = [];
            const correlationPairs = [];

            for (let i = 0; i < n; i++) {
                correlationMatrix[i] = [];
                for (let j = 0; j < n; j++) {
                    const col1 = selectedCols[i];
                    const col2 = selectedCols[j];
                    const data1 = parsedData.map(d => d[col1]);
                    const data2 = parsedData.map(d => d[col2]);
                    const corr = calculateCorrelation(data1, data2);
                    correlationMatrix[i][j] = corr;
                    
                    if (i < j) {
                        correlationPairs.push({
                            col1: col1,
                            col2: col2,
                            correlation: corr
                        });
                    }
                }
            }

            currentMatrix = correlationMatrix;
            currentLabels = selectedCols;
            
            drawHeatmap(correlationMatrix, selectedCols);
            generateInterpretation(correlationPairs, selectedCols);
            
            document.getElementById('chartSection').classList.add('show');
            document.getElementById('interpretationSection').classList.add('show');
            
            document.getElementById('chartSection').scrollIntoView({ behavior: 'smooth' });
        }

        function drawHeatmap(matrix, labels) {
            const canvas = document.getElementById('heatmapCanvas');
            const ctx = canvas.getContext('2d');
            
            const n = labels.length;
            const cellSize = Math.min(60, Math.max(40, 400 / n));
            const labelWidth = 100;
            const labelHeight = 80;
            const padding = 10;
            
            canvas.width = labelWidth + n * cellSize + padding * 2;
            canvas.height = labelHeight + n * cellSize + padding * 2;
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ì…€ ê·¸ë¦¬ê¸°
            for (let i = 0; i < n; i++) {
                for (let j = 0; j < n; j++) {
                    const x = labelWidth + j * cellSize + padding;
                    const y = labelHeight + i * cellSize + padding;
                    const corr = matrix[i][j];
                    
                    ctx.fillStyle = getCorrelationColor(corr);
                    ctx.fillRect(x, y, cellSize - 2, cellSize - 2);
                    
                    // ìƒê´€ê³„ìˆ˜ í…ìŠ¤íŠ¸
                    ctx.fillStyle = Math.abs(corr) > 0.5 ? 'white' : '#333';
                    ctx.font = `${Math.max(10, cellSize / 5)}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(corr.toFixed(2), x + cellSize / 2 - 1, y + cellSize / 2 - 1);
                }
            }
            
            // Yì¶• ë ˆì´ë¸”
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (let i = 0; i < n; i++) {
                const y = labelHeight + i * cellSize + cellSize / 2 + padding;
                const label = labels[i].length > 12 ? labels[i].substring(0, 10) + '...' : labels[i];
                ctx.fillText(label, labelWidth - 5 + padding, y);
            }
            
            // Xì¶• ë ˆì´ë¸”
            ctx.save();
            ctx.textAlign = 'left';
            for (let j = 0; j < n; j++) {
                const x = labelWidth + j * cellSize + cellSize / 2 + padding;
                const label = labels[j].length > 12 ? labels[j].substring(0, 10) + '...' : labels[j];
                ctx.save();
                ctx.translate(x, labelHeight - 5 + padding);
                ctx.rotate(-Math.PI / 4);
                ctx.fillText(label, 0, 0);
                ctx.restore();
            }
            ctx.restore();
            
            // íˆ´íŒ ì´ë²¤íŠ¸
            canvas.onmousemove = function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left - labelWidth - padding;
                const y = e.clientY - rect.top - labelHeight - padding;
                
                const j = Math.floor(x / cellSize);
                const i = Math.floor(y / cellSize);
                
                const tooltip = document.getElementById('tooltip');
                
                if (i >= 0 && i < n && j >= 0 && j < n) {
                    const corr = matrix[i][j];
                    const strength = getCorrelationStrength(corr);
                    tooltip.innerHTML = `<strong>${labels[i]}</strong> â†” <strong>${labels[j]}</strong><br>ìƒê´€ê³„ìˆ˜: ${corr.toFixed(3)}<br>${strength.text}`;
                    tooltip.style.left = (e.clientX + 15) + 'px';
                    tooltip.style.top = (e.clientY + 15) + 'px';
                    tooltip.style.display = 'block';
                } else {
                    tooltip.style.display = 'none';
                }
            };
            
            canvas.onmouseleave = function() {
                document.getElementById('tooltip').style.display = 'none';
            };
        }

        function generateInterpretation(pairs, columns) {
            if (pairs.length === 0) return;
            
            const correlations = pairs.map(p => p.correlation);
            const absCorrelations = correlations.map(c => Math.abs(c));
            const maxCorr = Math.max(...correlations);
            const minCorr = Math.min(...correlations);
            const avgAbsCorr = absCorrelations.reduce((a, b) => a + b, 0) / absCorrelations.length;

            document.getElementById('maxCorr').textContent = maxCorr.toFixed(3);
            document.getElementById('minCorr').textContent = minCorr.toFixed(3);
            document.getElementById('avgCorr').textContent = avgAbsCorr.toFixed(3);
            document.getElementById('pairCount').textContent = pairs.length;

            const sortedPairs = [...pairs].sort((a, b) => Math.abs(b.correlation) - Math.abs(a.correlation));

            let html = '<h3>ğŸ“‹ ìƒê´€ê´€ê³„ ë¶„ì„ ê²°ê³¼</h3>';
            
            html += '<div class="interpretation-item">';
            html += `<strong>ğŸ“Œ ë¶„ì„ ê°œìš”</strong><br>`;
            html += `ì„ íƒëœ <strong>${columns.length}ê°œ</strong> ë³€ìˆ˜ ê°„ì˜ ìƒê´€ê´€ê³„ë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤. `;
            html += `ì´ <strong>${pairs.length}ê°œ</strong>ì˜ ë³€ìˆ˜ ìŒì´ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤.<br>`;
            
            const strongCorr = pairs.filter(p => Math.abs(p.correlation) >= 0.7).length;
            const moderateCorr = pairs.filter(p => Math.abs(p.correlation) >= 0.4 && Math.abs(p.correlation) < 0.7).length;
            
            html += `â€¢ ê°•í•œ ìƒê´€ê´€ê³„ (|r| â‰¥ 0.7): <strong>${strongCorr}ê°œ</strong><br>`;
            html += `â€¢ ë³´í†µ ìƒê´€ê´€ê³„ (0.4 â‰¤ |r| < 0.7): <strong>${moderateCorr}ê°œ</strong>`;
            html += '</div>';

            html += '<h3 style="margin-top: 20px;">ğŸ” ì£¼ìš” ìƒê´€ê´€ê³„ (ìƒìœ„ 10ê°œ)</h3>';
            
            sortedPairs.slice(0, 10).forEach((pair, index) => {
                const strength = getCorrelationStrength(pair.correlation);
                const direction = pair.correlation > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
                
                html += '<div class="interpretation-item">';
                html += `<strong>${index + 1}. ${pair.col1}</strong> â†” <strong>${pair.col2}</strong>`;
                html += `<span class="correlation-badge ${strength.class}">${strength.text}</span>`;
                html += `<br><span style="color: #666;">ìƒê´€ê³„ìˆ˜: <strong>${pair.correlation.toFixed(3)}</strong></span>`;
                html += `<br>${direction} ${getInterpretationText(pair.correlation)}`;
                html += '</div>';
            });

            html += '<div class="interpretation-item insight">';
            html += '<strong>ğŸ’¡ ë¶„ì„ ì¸ì‚¬ì´íŠ¸</strong><br>';
            html += generateInsights(sortedPairs, avgAbsCorr);
            html += '</div>';

            document.getElementById('interpretationContent').innerHTML = html;
        }

        function getInterpretationText(corr) {
            const absCorr = Math.abs(corr);
            const direction = corr > 0 ? 'ì–‘ì˜' : 'ìŒì˜';
            
            if (absCorr >= 0.9) {
                return `ë§¤ìš° ê°•í•œ ${direction} ì„ í˜• ê´€ê³„ê°€ ìˆìŠµë‹ˆë‹¤. ë‘ ë³€ìˆ˜ëŠ” ê±°ì˜ ì™„ë²½í•˜ê²Œ ${corr > 0 ? 'ê°™ì€' : 'ë°˜ëŒ€'} ë°©í–¥ìœ¼ë¡œ ì›€ì§ì…ë‹ˆë‹¤.`;
            } else if (absCorr >= 0.7) {
                return `ê°•í•œ ${direction} ìƒê´€ê´€ê³„ì…ë‹ˆë‹¤. í•œ ë³€ìˆ˜ê°€ ë³€í•  ë•Œ ë‹¤ë¥¸ ë³€ìˆ˜ë„ ${corr > 0 ? 'ê°™ì€' : 'ë°˜ëŒ€'} ë°©í–¥ìœ¼ë¡œ ìƒë‹¹íˆ ë³€í•©ë‹ˆë‹¤.`;
            } else if (absCorr >= 0.4) {
                return `ë³´í†µ ìˆ˜ì¤€ì˜ ${direction} ìƒê´€ê´€ê³„ì…ë‹ˆë‹¤. ë‘ ë³€ìˆ˜ ì‚¬ì´ì— ì–´ëŠ ì •ë„ ê´€ë ¨ì„±ì´ ìˆìŠµë‹ˆë‹¤.`;
            } else if (absCorr >= 0.2) {
                return `ì•½í•œ ${direction} ìƒê´€ê´€ê³„ì…ë‹ˆë‹¤. ë‘ ë³€ìˆ˜ ì‚¬ì´ì— ë¯¸ì•½í•œ ê´€ë ¨ì„±ì´ ìˆìŠµë‹ˆë‹¤.`;
            } else {
                return `ìƒê´€ê´€ê³„ê°€ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤. ë‘ ë³€ìˆ˜ëŠ” ë…ë¦½ì ìœ¼ë¡œ ì›€ì§ì…ë‹ˆë‹¤.`;
            }
        }

        function generateInsights(pairs, avgAbsCorr) {
            let insights = [];
            
            const strongestPositive = pairs.filter(p => p.correlation > 0)
                                           .sort((a, b) => b.correlation - a.correlation)[0];
            if (strongestPositive && strongestPositive.correlation >= 0.5) {
                insights.push(`<strong>${strongestPositive.col1}</strong>ê³¼(ì™€) <strong>${strongestPositive.col2}</strong>ì´(ê°€) ê°€ì¥ ê°•í•œ ì–‘ì˜ ìƒê´€ê´€ê³„(${strongestPositive.correlation.toFixed(3)})ë¥¼ ë³´ì…ë‹ˆë‹¤. ì´ ë‘ ë³€ìˆ˜ëŠ” í•¨ê»˜ ì¦ê°€í•˜ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤.`);
            }
            
            const strongestNegative = pairs.filter(p => p.correlation < 0)
                                           .sort((a, b) => a.correlation - b.correlation)[0];
            if (strongestNegative && strongestNegative.correlation <= -0.5) {
                insights.push(`<strong>${strongestNegative.col1}</strong>ê³¼(ì™€) <strong>${strongestNegative.col2}</strong>ì´(ê°€) ê°•í•œ ìŒì˜ ìƒê´€ê´€ê³„(${strongestNegative.correlation.toFixed(3)})ë¥¼ ë³´ì…ë‹ˆë‹¤. í•œ ë³€ìˆ˜ê°€ ì¦ê°€í•˜ë©´ ë‹¤ë¥¸ ë³€ìˆ˜ëŠ” ê°ì†Œí•˜ëŠ” ê²½í–¥ì´ ìˆìŠµë‹ˆë‹¤.`);
            }
            
            if (avgAbsCorr >= 0.5) {
                insights.push('ì „ë°˜ì ìœ¼ë¡œ ë³€ìˆ˜ë“¤ ì‚¬ì´ì— ìƒë‹¹í•œ ìƒê´€ê´€ê³„ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ë‹¤ì¤‘ê³µì„ ì„± ì—¬ë¶€ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.');
            } else if (avgAbsCorr <= 0.2) {
                insights.push('ì „ë°˜ì ìœ¼ë¡œ ë³€ìˆ˜ë“¤ì´ ë…ë¦½ì ì…ë‹ˆë‹¤. ê° ë³€ìˆ˜ê°€ ì„œë¡œ ë‹¤ë¥¸ ì •ë³´ë¥¼ ë‹´ê³  ìˆì„ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.');
            }
            
            if (insights.length === 0) {
                insights.push('ë°ì´í„°ì˜ íŠ¹ì„±ì„ íŒŒì•…í•˜ê³  ì¶”ê°€ ë¶„ì„ì„ ì§„í–‰í•´ë³´ì„¸ìš”.');
            }
            
            return insights.join('<br><br>');
        }
    </script>
</body>
</html>
